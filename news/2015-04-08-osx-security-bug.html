<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Remotely send Chrome and Node.js into infinite loops via this one weird OSX kernel bug - Sandstorm Blog</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta property="og:title" content="Remotely send Chrome and Node.js into infinite loops via this one weird OSX kernel bug">
    <meta property="og:type" content="website">
    <meta property="og:image" content="https://sandstorm.io/images/sandcat.png">
    <meta property="og:url" content="https://sandstorm.io/news/2015-04-08-osx-security-bug">
    <meta property="og:description"
        content="Real-time collaborative web productivity suite behind the firewall.">
    <link rel="stylesheet" type="text/css" href="/style.css">
    <link rel="alternate" type="application/rss+xml" title="Sandstorm.io Blog" href="/feed.xml">
    
<script src="/ga-helper.js"></script>
<script>
(function(){

function getIdFromCookie() {
  var match = document.cookie.match(new RegExp("(^| )sandstormStatsId=([^;]+)"));
  if (match) return match[2];
}

function setIdCookie(val) {
  var d = new Date();
  d.setMonth(d.getMonth() + 120);
  document.cookie = "sandstormStatsId=" + val + ";expires=" + d + ";domain=.sandstorm.io;";
}

function uidGenerator() {
  if (window.crypto && window.crypto.getRandomValues) {
    var array = new Uint32Array(4);
    window.crypto.getRandomValues(array);
    return array[0] + "-" + array[1] + "-" + array[2] + "-" + array[3];
  } else {
    var genInt = function() {
      return Math.floor(Math.random() * 0x100000000);
    }
    return genInt() + "-" + genInt() + "-" + genInt() + "-" + genInt();
  }
}

function getId() {
  var id = getIdFromCookie();
  if (!id) {
    id = uidGenerator();
    setIdCookie(id);
  }
  return id;
}

function sendData(data, path) {
  var xhr = new XMLHttpRequest();

  xhr.onreadystatechange = function () {
    if (xhr.readyState == 4) {
      if (xhr.status >= 200 && xhr.status < 300) {
        // do nothing
      } else {
        console.error("analytics send failed:", xhr.statusText, xhr.responseText);
      }
    }
  };

  xhr.open("POST", "https://api-5d23e9c497f90642a85ba1fb909fa9d8.oasis.sandstorm.io/" + path, true);

  xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
  xhr.setRequestHeader("Authorization", "Bearer hVU87Vp2UzNnRmMepiXpjKUk6n6MZc7YMgAJ6YrVe-6");

  xhr.send(JSON.stringify(data));
}


function isInExperiment(userId, exp) {
  var idBlocks = userId.split("-");
  var id = parseInt(idBlocks[0], 10);
  return exp.exp_range_start <= id && id < exp.exp_range_end;
}

function addCssOverride(inExperiment, id, activeDisplayValue) {
  var s = document.createElement('style');
  s.type = 'text/css';
  var r = "";
  if (inExperiment) {
    r = r + ".exp-" + id + "-baseline { display: none !important; }\n";
    r = r + ".exp-" + id + "-test { display: " + activeDisplayValue + " !important; }\n";
  }
  s.innerHTML = r;
  document.getElementsByTagName('head')[0].appendChild(s);
}

var experiments = [
  {
    id: "install-screencast-autoplay",
    exp_range_start: 0,
    exp_range_end: 0x7fffffff, // 50% of users
    hook: function (userId, exp, inExperiment) {
      // Creates a stylesheet with a pair of classes that change the display: property,
      // allowing hiding of baseline content and showing of experimental content.
      addCssOverride(inExperiment, exp.id, "block");
    }
  },
  {
    id: "donations-bar",
    exp_range_start: 0,  // disable
    exp_range_end: 0,
    hook: function (userId, exp, inExperiment) {
      addCssOverride(inExperiment, exp.id, "flex");
    }
  }
];

var experimentMembership = {};
var userId = getId();
for (var i=0; i<experiments.length; i++) {
  var exp = experiments[i];
  var a = isInExperiment(userId, exp);
  exp.inExperiment = a;
  experimentMembership[exp.id] = a;
}

function runExperimentHooks() {
  for (var i=0; i<experiments.length; i++) {
    var exp = experiments[i];
    if (exp.hook) {
      exp.hook(userId, exp, exp.inExperiment);
    }
  }
}

function trackView() {
  var id = getId();
  sendData({
    uid: id,
    referrer: document.referrer,
    location: window.location + '',
    experiments: experimentMembership
  }, "pageEvent");
}

function trackClick(elementId) {
  var id = getId();
  sendData({
    uid: id,
    elementId: elementId,
    location: window.location + '',
    experiments: experimentMembership
  }, "clickEvent");
}


runExperimentHooks();
trackView();

window.sandstormTracker = {
  trackView: trackView,
  trackClick: trackClick,
  experiments: experiments,
  getId: getId
};

})();
</script>

  </head>



  <body id="blog">
    <nav>
      <a href="/">Sandstorm.io</a>
      <a href="/get">Get Sandstorm</a>
      <a href="/features">Features</a>
      <a href="/news/">Blog</a>
      <a href="https://docs.sandstorm.io">Docs</a>
      <a href="/community">Community</a>
      <!-- TODO: search -->
    </nav>
    <div class="notice exp-donations-bar-test" id="notice1">
      <span>Your donations help us make open source apps viable.</span>
      <form class="donate-form" action="/">
        <label class="donate-label" for="donate-top">$</label>
        <input class="donate-input" id="donate-top"  name="AMOUNT" type="number" value="10" required>
        <button type="submit">Donate</button>
      </form>
    </div>

    <header>
  <div class="sand">
    <h1>Sandstorm Blog</h1>
  </div>
</header>

<div class="post-list">

<div class="sidebar">
  <ul class="socialmedia">
    <li><a class="twitter" href="https://twitter.com/SandstormIO">Twitter</a>
    <li><a class="facebook" href="https://www.facebook.com/sandstorm.io" target="blank">Facebook</a>
    <li><a class="google" href="https://plus.google.com/+SandstormIo" target="_blank">Google</a>
    <li><a class="github" href="https://github.com/sandstorm-io/sandstorm" target="_blank">Github</a>
  </ul>

  <div class="more">
    <form id="signup" action="https://sandstorm.us7.list-manage.com/subscribe/post?u=1a036c5ea0fc3c215793748ed&amp;id=5d9399a0af" method="post">
      Join our mailing list for updates<br>
      <input type="email" name="EMAIL" placeholder="E-mail" required><input type="submit" value="Submit">
    </form>
    <a href="/get">
      Sandstorm is a self-hostable web productivity suite.
      <span class="signup" href="https://oasis.sandstorm.io">Sign up for free</span>
      <span class="selfhost" href="/install">or host your own</span>
    </a>
    
    <h3>Recommended Posts</h3>
    <ul>
      <li><a href="/news/2014-07-21-open-source-web-apps-require-federated-hosting">Open Source Web Apps Aren't Viable; Let's Fix That</a></li>
      <li><a href="/news/2016-02-29-security-track-record">Sandstorm's security track record, and what it means for self-hosting</a></li>
      <li><a href="/news/2016-08-17-decentralization-is-about-diversity">Decentralization is about diversity</a></li>
      <li><a href="/news/2016-01-22-8-new-open-source-apps.html">8 New open source self-hostable apps</a></li>
      <li><a href="/news/2016-04-06-sandstorm-for-work">Sandstorm for Work Beta: LDAP, SAML, organization management</a></li>
      <li><a href="/news/2016-02-05-app-author-publicity-oasis">Free publicity for your indie web app, and free Oasis service for you</a></li>
      <li><a href="/news/2015-10-01-free-ssl-certificates.html">Free, automated SSL certificates for Sandstorm self-hosters</a></li>
      <li><a href="/news/2014-08-19-why-not-run-docker-apps.html">Why doesn't Sandstorm just run Docker apps?</a></li>
      <li><a href="/news/2015-05-05-delegation-is-the-cornerstone-of-civilization.html">Understand the Sandstorm sharing model</a></li>
    </ul>
    
    <h3>Further Reading</h3>
      <ul>
        <li><a href="/how-it-works">How Sandstorm Works</a></li>
        <li><a href="http://docs.sandstorm.io">Sandstorm Documentation</a></li>
        <li><a href="/install">How to install Sandstorm</a></li>
      </ul>
  </div>
</div>


<nav class="pagination top">
  <a class="newer" href="/news/" title="All posts">&laquo; All posts</a>
</nav>

<section>
  <h2>Remotely send Chrome and Node.js into infinite loops via this one weird OSX kernel bug</h2>
  <p class="post-details">By <a href="https://github.com/kentonv">Kenton Varda</a>
    
    - 08 Apr 2015
  <p>A few months ago I discovered a security bug in the Darwin kernel used by most Apple products. The bug could allow an attacker to trivially remotely DoS a variety of network services and apps, from Node.js to Chrome. Today, <a href="https://support.apple.com/en-us/HT204659">Apple released a patch</a> (look for CVE-2015-1105), so now I can tell you about it.</p>

<p>Now, just to be clear, I’m no <a href="https://www.imperialviolet.org/">Adam Langley</a>. This bug is “just” a DoS, nothing like a Heartbleed or a Shellshock. The worst it can do is allow an attacker to cause a temporary service disruption. But I think all security bugs deserve a writeup so that we can learn from them, and Apple’s terse description of the problem doesn’t accomplish this. Also, it’s a fun story.</p>

<p>I discovered the problem while doing research on the different interfaces that various operating systems provide for doing event-driven I/O – that is, how you tell the platform: “Here are all my open connections; wake me up when one of them receives a message.” It turns out that every OS does this differently. Linux has <code>epoll</code>. BSD has <code>kqueue</code>. Windows has… well, about five different mechanisms that cover differing subsets of usecases and you can only choose one. In any case, I was trying to build an abstraction layer over these for <a href="https://capnproto.org">Cap’n Proto</a>, so I wanted to make sure I understood them all.</p>

<p>I noticed a curious thing: some man pages discussed an event called “out-of-band data” while others didn’t. “Out-of-band data” (OOB), also known as “urgent data”, is a little-used feature of TCP connections that essentially allows you to send a byte that “jumps the queue” so that the receiving app can receive it before receiving other data sent before it. You probably didn’t know about this, because basically no one uses this feature – except for Telnet, which needs a way to signal that you pressed “ctrl+C” when the destination app is not otherwise processing input.</p>

<p>With almost all event notification APIs, regular data and OOB data raise different kinds of events. For example, <code>poll()</code> (and its successor on Linux, <code>epoll</code>) has <code>POLLIN</code> for regular data and <code>POLLPRI</code> for OOB. This way, if your app does not expect to receive OOB data, it simply doesn’t ask to be notified about that type of event, and the kernel happily discards it for you (or maybe inserts it into the regular stream, which is fine).</p>

<p>Curiously, the BSD <code>kqueue</code> docs are unclear on how OOB data is handled. <a href="https://www.freebsd.org/cgi/man.cgi?query=kqueue&amp;sektion=2">FreeBSD’s <code>kqueue</code></a> makes no mention of it, and as far as I’ve been able to determine it simply doesn’t support notification of OOB events at all. <a href="http://leaf.dragonflybsd.org/cgi/web-man?command=kqueue&amp;section=2">DragonflyBSD’s <code>kqueue</code></a> defines an <code>EVFILT_EXCEPT</code> event type.</p>

<p><a href="https://developer.apple.com/library/mac/documentation/Darwin/Reference/ManPages/man2/kqueue.2.html">Darwin’s (OSX/iOS) <code>kqueue</code></a> also doesn’t mention OOB data, but some Googling revealed an undocumented “feature”: on OOB data, Darwin will raise a regular <code>EVFILT_READ</code> event (which normally indicates that regular in-band data was received) but set the special flag <code>EV_OOBAND</code> on the event structure.</p>

<p>Of course, if you aren’t <em>expecting</em> OOB data, you’re not going to check for that flag. So when you receive <code>EVFILT_READ</code>, you’re going to believe you’ve received regular data. And you’re going to do a <code>recv()</code> call to read that data, and there isn’t going to be any. And then you’re going to say “oh well” and return to the event loop. But if you are using <code>kqueue()</code> in level-triggered mode (as most people do, because it’s easier), then the operating system is going to see that the OOB data is still there, and is going to give you <em>the exact same event again</em>.</p>

<p>So you go into an infinite loop.</p>

<p><strong>Wait, doesn’t that mean almost all event-driven OSX network apps will go into an infinite loop if they receive a single TCP packet with the urgent bit set?</strong></p>

<p>I didn’t think that could possibly be true at first, so I fired up a Mac machine to try it. Sure enough:</p>

<ul>
  <li>
    <p>When Google Chrome visited an HTTP server that sent back an OOB byte, the whole app (not just the tab, but everything) locked up and had to be force-quit. It turns out Chrome does all networking from the main process, so the per-tab process separation did not help. (<a href="https://code.google.com/p/chromium/issues/detail?id=437642">Chromium issue 437642</a> – currently still locked down as a security issue)</p>
  </li>
  <li>
    <p>When a <a href="https://nodejs.org">Node.js</a> server received an OOB byte from a client, the server would go into an infinite loop and stop handling other connections. (<a href="https://github.com/libuv/libuv/commit/e19089f7b14800d3f9bd74d9699e841e4b61a36d">fixed in this commit</a>)</p>
  </li>
</ul>

<p>On the other hand, my third test case – <a href="http://nginx.org">nginx</a> – was not affected, because it uses kqueue in edge-triggered mode, and therefore it only receives the unexpected event when new data arrives rather than any time data is available – i.e. once rather than infinity times. But two of three is a pretty worrisome hit rate, especially when these are some very big names.</p>

<p>Arguably the worst / most interesting part of this problem is that it was a problem inherent in the API. Technically it was not that the kernel was buggy, but that the interface was confusing (and underdocumented) in a way that caused the same bug to manifest in several different apps. Fixing the problem either required fixing every app (and being ever-vigilant in the future), or changing the API and <em>breaking</em> any existing app that depended on the behavior (of which there appears to be a few).</p>

<p>To Apple’s credit, they did what I think is the right thing: they changed the interface so that it no longer reports <code>EVFILT_READ</code> events on TCP OOB data. I do not quite understand their description of this problem as a “state inconsistency issue”, but my tests confirm that OOB data is now ignored.</p>

<p>The moral of the story? <strong>Confusing APIs are a security problem. If many users of your API get it wrong in a way that introduces a security bug, that’s a bug in your API, not their code.</strong></p>

</section>

</div>


    <div class="notice exp-donations-bar-test" id="notice2">
      <span>Your donations help us make open source apps viable.</span>
      <form class="donate-form" action="/">
        <label class="donate-label" for="donate-bottom">$</label>
        <input class="donate-input" id="donate-bottom"  name="AMOUNT" type="number" value="10" required>
        <button type="submit">Donate</button>
      </form>
    </div>
    <footer>
      <ul>
        <li>
          <h3><a href="/get">Get Sandstorm</a></h3>
          <ul>
            <li><a href="/get">Sandstorm on Oasis</a>
            <li><a href="/get">Sandstorm Standard</a>
            <li><a href="/get">Sandstorm for Work</a>
            <li><a href="https://github.com/sandstorm-io/sandstorm">Source Code (GitHub)</a>
            <li><a href="/go/education">For Educators</a></li>
          </ul>
        </li>
        <li>
          <h3><a href="/features">Features</a></h3>
          <ul>
            <li><a href="https://apps.sandstorm.io">App Market</a></li>
            <li><a href="/features">Core features</a>
            <li><a href="/features#security">Security features</a>
            <li><a href="/business">Sandstorm for Work</a>
            <li><a href="/business#scale">Sandstorm for Enterprise</a>
            <li><a href="/developer">Development</a>
          </ul>
        </li>
        <li>
          <h3><a href="https://docs.sandstorm.io">Documentation</a></h3>
          <ul>
            <li><a href="https://docs.sandstorm.io/en/latest/using/">How to use Sandstorm</a>
            <li><a href="https://docs.sandstorm.io/en/latest/developing/">Developer Hub</a>
            <li><a href="https://docs.sandstorm.io/en/latest/administering/">Administering &amp; installing</a>
            <li><a href="https://docs.sandstorm.io/en/latest/using/security-practices/">Security</a>
          </ul>
        </li>
        <li>
          <h3><a href="/how-it-works">How it Works</a></h3>
          <ul>
            <li><a href="/how-it-works#grains">Fine-grained object containers</a>
            <li><a href="/how-it-works#capabilities">Capability-based Security</a>
          </ul>
        </li>
        <li>
          <h3><a href="/community">Community</a></h3>
          <ul>
            <li><a href="/news">Sandstorm Blog</a>
            <li><a href="/community#connect-with">Connect with us</a>
            <li><a href="/community#helpothers">Help Others</a>
            <li><a href="/community#helpproject">Help the Project</a>
          </ul>
        </li>
        <li>
          <h3><a href="/about">About</a></h3>
          <ul>
            <li><a href="/about">Sandstorm Story</a>
            <li><a href="/about#team">Team</a>
            <li><a href="/about#advisors">Advisors</a>
            <li><a href="mailto:contact@sandstorm.io">Contact</a>
          </ul>
        </li>
        <li>
          <h3><a href="https://oasis.sandstorm.io">Oasis Hosting</a></h3>
          <ul>
            <li class="sign-in-footer"><a href="https://oasis.sandstorm.io">Sign in</a>
          </ul>
        </li>
        <li>
          <h3>Connect</h3>
          <ul id="socialmedia-small">
						<li><a class="twitter" href="https://twitter.com/SandstormIO"></a>
						<li><a class="google" href="https://plus.google.com/+SandstormIo" target="_blank"></a>
						<li><a class="facebook" href="https://www.facebook.com/sandstorm.io" target="blank"></a>
						<li><a class="github" href="https://github.com/sandstorm-io/sandstorm" target="_blank"></a>
  			</ul>
        </li>
        <li>
          <h3>Join our mailing list!</h3>
            <div class="subscribe-small">
                                                        <form action="https://sandstorm.us7.list-manage.com/subscribe/post?u=1a036c5ea0fc3c215793748ed&amp;id=5d9399a0af" method="post">
                                                                <input type="email" name="EMAIL" placeholder="e-mail" required>
                                                                <input type="submit" value="Submit">
                                                                </form>
            </div>
          <ul>
            <li><a href=""></a>
          </ul>
        </li>
      </ul>
      <p>This page was hand-crafted using only the finest web technologies.
    </footer>

    <!-- Google Analytics -->
    <script type="text/javascript">
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-42127409-1', 'sandstorm.io');
      ga('send', 'pageview');
    </script>

    <!-- livereload, for development -->
    <script type="text/javascript">
      if (document.location.hostname === "localhost") {
        document.write('<script src="http://localhost:35729/livereload.js"></scr' + 'ipt>');
      }
    </script>

    <!-- Donation form integration -->
    <script src="https://checkout.stripe.com/checkout.js"></script>
    <script>
    var amountCents = 0;
    var handler = StripeCheckout.configure({
      key: "pk_live_bkrz8iFkfEeXDsdIqzDNdSkH",
      image: "https://sandstorm.io/images/sandstorm-purplecircle.png",
      locale: "auto",
      token: function(token) {
        var xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function () {
          if (xhr.readyState === 4) {
            if (xhr.status !== 200) {
              console && console.error(xhr.responseText);
            } else {
              console && console.log("donation successful");
            }
          }
        };
        xhr.open("POST", "https://donations-backend.sandstorm.io/", true);
        var formData = new FormData();
        formData.append("token_id", token.id);
        formData.append("token_email", token.email);
        formData.append("amount", amountCents);
        xhr.send(formData);
        window.sandstormTracker && window.sandstormTracker.trackClick("donation-complete");
      }
    });
    var submitDonateForm = function(e) {
      window.lastEvent = e;
      e.preventDefault();
      var dollars = parseFloat(e.target.querySelector("input").value);
      amountCents = Math.floor(100*dollars);
      handler.open({
        name: "Sandstorm.io",
        description: "Donation (not tax deductible)",
        zipCode: true,
        amount: amountCents,
      });
      window.sandstormTracker && window.sandstormTracker.trackClick("donate-button");
    };
    var forms = document.querySelectorAll("form.donate-form");
    for (var i=0; i<forms.length; i++) {
      var form = forms[i];
      form.onsubmit = submitDonateForm;
    }
    // Close checkout on page navigation.
    window.addEventListener("popstate", function() {
      handler.close();
    });
    </script>
  </body>
</html>
