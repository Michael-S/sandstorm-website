---
layout: post
title: "Linux kernel CVE-2016-5195 \"Dirty COW\" mitigated by Sandstorm"
author: Kenton Varda
authorUrl: https://github.com/kentonv
---

Last week, a Linux kernel bug, [CVE-2016-5195](https://www.google.com/search?q=CVE-2016-5195), was described as ["the most serious Linux local privilege escalation ever"](http://arstechnica.com/security/2016/10/most-serious-linux-privilege-escalation-bug-ever-is-under-active-exploit/). The bug -- which potentially allowed any code running on a Linux machine to escalate its privileges to root -- was already being actively exploited in the wild before it was fixed, and had existed in the kernel for many years.

Since Sandstorm allows any user of a server to upload their own apps, you might wonder if this bug could allow a Sandstorm user to compromise the server.

We're happy to report that the answer is "no". As is [often the case](https://docs.sandstorm.io/en/latest/using/security-non-events/#linux-kernel) with Linux kernel bugs, our sandbox blocked the exploit.

The bug in question was a race condition in the handling of memory pages mapped copy-on-write. A process can ask that a read-only file be mapped into its memory space in such a way that it is allowed to modify the mapped memory. When the process writes to the memory, the kernel makes a private copy of the affected page, so that the process only modifies its copy, not the original. Meanwhile, a process can request later on that the modifications it made be discarded, returning the page to its original state. In certain circumstances, by both writing to a page and requesting this discard at the same time (in separate threads), the process could end up writing to the original pages that are shared with other processes on the system, instead of its own private copy. Hence, the process could modify any file on the system. By modifying, say, the `sudo` utility, it could give itself a backdoor which allows it to gain root privileges trivially.

However, not just any old write worked here. In order to trigger the race condition, the process had to write in a way that calls the kernel's `get_user_pages()` function with the `force` parameter set to `1`. The `force` parameter says: "If this page is mapped copy-on-write, then let me write to it (making a private copy) even if the page's protection mode is read-only." As it turns out, it is possible for a memory mapping to be both read-only and copy-on-write, and in fact this is the mode that is usually used when mapping in a program's main binary and shared libraries. Normally, no copy is ever performed, because the writes that would trigger them are not allowed. However, there is a special case where this combination of flags matters: If you are running a program in a debugger, and you ask the debugger to insert a breakpoint, it does so by overwriting the instruction at the given address with a break instruction. That is, it modifies the mapped executable. The `force` flag actually exists for exactly this purpose: so that the debugger can inject breakpoints into the program being executed by the process being debugged (without affecting any other processes that happen to be running the same program).

Because the `force` flag is only useful in very specific circumstances, only certain code paths can trigger the vulnerability. Kernel security engineer and Sandstorm contributor Andrew Lutomirski tells us the only entry points appear to be:

* The `ptrace()` system call's `PTRACE_POKEDATA` operation, which is explicitly meant to be used by debuggers, often for the purpose of setting breakpoints.
* Writes to `/proc/<pid>/mem`. This appears to be a mistake -- there's no apparent reason why this should use `force`. Probably, someone was copy-pasting code.
* Various drivers, which are also probably using the flag by mistake.

As it turns out, none of these code paths can be exploited by Sandstorm apps:

* Sandstorm uses seccomp to block the app from invoking `ptrace()`.
* Sandstorm does not mount `/proc` inside app sandboxes.
* Sandstorm does not expose driver interfaces from inside app sandboxes. For example, `/dev` contains only `null`, `zero`, `urandom`, and `random` (which is actually a synonym for `urandom`, [as it](https://gist.github.com/tarcieri/6347417) [should be](http://www.2uo.de/myths-about-urandom/)).

So, as far as we can tell, Sandstorm has never been vulnerable to this bug.

### Defense in depth

Even if Sandstorm were vulnerable, the exploit would have far reduced impact inside Sandstorm than in a typical Linux environment, because:

* A Sandstorm app's filesystem consists of the contents of its own package. It cannot see the host system's files nor files belonging to other apps, hence it would not be able to memory-map them in order to modify them using this bug.
* App packages cannot contain setuid binaries and, even if they could, apps would not be able to execute them, because Sandstorm sets the `NO_NEW_PRIVS` `prctl()` flag inside the sandbox.

Because of these considerations, even if Sandstorm had not mitigated the bug outright, the impact of the bug would be that one instance of an app could attack other instances of the same app (running on the same machine in separate containers). Most apps do not allow a remote user to upload arbitrary code to execute and, hence, would only be vulnerable if the app author had included attack code in the app. On Sandstorm, we would consider this a vulnerability, because Sandstorm seeks to implement "confinement", meaning that an app should not be able to "phone home" to its author or speak to other copies of itself without permission.

Interestingly, though, on most platforms, it's fully expected that instances of the same app can voluntarily collude with each other, e.g. by communicating with a central coordinator or by simply opening network connections to each other. And actually, Sandstorm does not yet fully implement confinement either -- we intend to, and an app has to go out of its way to break confinement today, but we have not yet prioritized systematically closing all holes.

So, even if Sandstorm had not directly mitigated this bug, and barring some as-yet-unreported impact of this vulnerability, we believe that it would not have allowed the app to do anything except coordinate with other instances of itself, which it could already do by communicating through the network, which on most platforms wouldn't even be considered a bug.

### The List

This is not the first Linux security bug mitigated by Sandstorm. In fact, we've kept a long list. Check it out at: [Sandstorm Security Non-Events](https://docs.sandstorm.io/en/latest/using/security-non-events/#linux-kernel)
